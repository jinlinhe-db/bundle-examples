trigger:
- main

pool:
  vmImage: ubuntu-22.04

variables:
 - name: BUNDLE_TARGET
   value: dev
 - name: BUNDLE_ROOT
   value: mlops_stacks/mlops_stacks


steps:
  - checkout: self

  - script: | 
      set -e
      curl -fsSL https://raw.githubusercontent.com/databricks/setup-cli/main/install.sh | sh
    displayName: Install databricks cli

  - script: |
      https://raw.githubusercontent.com/databricks/setup-cli/main/install.sh
      databricks bundle validate -t $(BUNDLE_TARGET)
    displayName: Validate bundle
    workingDirectory: $(Agent.BuildDirectory)/s/$(BUNDLE_ROOT)
    env:
      DATABRICKS_CLIENT_ID: $(DATABRICKS_CLIENT_ID)
      DATABRICKS_CLIENT_SECRET: $(DATABRICKS_CLIENT_SECRET)

  - script: |
      set -e
      databricks bundle deploy -t $(BUNDLE_TARGET)
    displayName: Deploy bundle
    workingDirectory: $(Agent.BuildDirectory)/s/$(BUNDLE_ROOT)
    env:
      DATABRICKS_CLIENT_ID: $(DATABRICKS_CLIENT_ID)
      DATABRICKS_CLIENT_SECRET: $(DATABRICKS_CLIENT_SECRET)

